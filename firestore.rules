rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to validate data structure
    function hasValidStructure() {
      return request.resource.data.keys().hasAny(['familyMembers']) &&
             request.resource.data.familyMembers is map;
    }

    // Helper function to check if this is a valid participant update
    function isValidParticipantUpdate() {
      // Must have familyMembers
      return hasValidStructure();
      // Note: Members can be added, updated, or deleted
      // In production, you may want to add admin secret verification
      // to restrict who can delete members
    }

    // Match any collection that could be used for Secret Santa events
    match /{collection}/{year} {

      // Allow reading event data
      // Everyone needs to see participants and gift ideas
      allow read: if true;

      // Allow creating new events
      // Note: In production, protect your Firebase API keys with domain restrictions
      // and use Firebase App Check for additional security
      allow create: if hasValidStructure();

      // Allow deleting events
      // Note: You may want to add adminSecret check here
      allow delete: if resource != null;

      // Allow updates for:
      // - Drawing names (updating assigned, santaFor, hasSanta)
      // - Adding gift ideas
      // - Admin operations
      allow update: if isValidParticipantUpdate();
    }

    // Add a metadata collection for tracking operations (optional)
    match /metadata/{document} {
      allow read: if true;
      allow write: if false;
    }
  }
}
